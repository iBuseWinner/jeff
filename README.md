# cclc-jeff

Джефф - настраиваемый и расширяемый чат-бот для десктопов.

## Сборка

Генерация Make-файла выполняется командой `$ cmake -S ./ -B /path/of/makefile/dir`.

## Описание

### Встроенный поиск выражений-триггеров

Джефф предоставляет встроенный поиск триггеров в введённых выражениях пользователя. Для ответа на них используются базы данных \*.j.db (SQLite).

Чтобы создать базу данных, откройте `Файл > Менеджер источников` или напишите сообщение `/src`. В ответном сообщении нажмите `Добавить контейнер |> Создать`, введите любое название источника, выберите файл для сохранения и нажмите `Сохранить`. Для сохранения изменений нажмите `Сохранить и закрыть`.

Содержимое базы данных включает в себя таблицу `sources` с определёнными свойствами, никнеймом источника (в одной базе данных может быть несколько источников) и его UUID, а также сами таблицы источников.

Источник представляет из себя таблицу с тремя столбцами: 

- адрес выражения
- само выражение
- ссылки от данного выражения на другие
- исполняемый бит (будет добавлен в версии 0.5.0).

Таким образом, использование баз данных может заключаться в подобном примере:

```
1 | Привет!                          | 1,2,3 | 0
2 | Здравствуй!                      | 1,2,3 | 0
3 | handle_in_script="greetings.py"; |       | 1
4 | Что такое                        | 5     | 0
5 | handle_in_script="wiki.py"       |       | 1
```

Выражения могут ссылаться сами на себя. Выбор между вариантами происходит случайным образом.

Ядро поиска триггеров находится в классе `NLPmodule`. Ядро собирает из кэша выражения (если не находит - из остальных источников), освобождает от знаков препинания, делает регистронезависимыми, затем ищет их вхождения в пользовательский ввод. Если выражение активатора было найдено с определённой точностью, выражение реагирования добавляется в список кандидатов. Из списка кандидатов выбираются выражения с максимальным покрытием, наибольшим весом и наименьшим числом использования. Если треть ввода не покрыта ответными выражениями, поиск повторяется по источникам, если использовался только кэш.

### Скрипты и гибкая система настройки поведения (в версии 0.5.0)

Джефф может обрабатывать выражения при помощи внешних скриптов в нескольких случаях:

1. При запуске программы (startup).
2. При любом вводе пользователя (custom_scan).
3. При необходимости ответить на ввод пользователя (answer).
4. При необходимости иначе скомпоновать полученные результаты (custom_compose).

#### Запуск программы

Скрипт должен иметь функцию `startup` без аргументов.

#### Обработка ввода пользователя

Выражение имеет вид `handle_in_script="путь до файла"; type="custom_scan"; get_hist="число последних сообщений"`. Скрипт должен иметь функцию `answer`. Единственным аргументом передаётся JSON-строка с историей сообщений.

#### Ответ на ввод пользователя

Выражение имеет вид `handle_in_script="путь до файла"; type="answer"; get_hist="число последних сообщений"`. Скрипт должен иметь функцию `answer`. Единственным аргументом передаётся JSON-строка с историей сообщений.

#### Кастомная компоновка результатов сканирования NLPmodule

Выражение имеет вид `handle_in_script="путь до файла"; type="answer"; get_hist="число последних сообщений"`. Скрипт должен иметь функцию `custom_compose`. Единственным аргументом передаётся JSON-строка с историей сообщений.

Кастомная компоновка не предоставляет какого-либо ответного выражения, но если активатор попадает в выборку, то компоновка автоматически передаётся скрипту с наибольшим весом. В функцию передаются вводная строка и предлагаемые варианты. (TODO)

#### Дополнительные опции запроса

`"value": "передать данные под данным ключом"` - отправляет дополнительно в функцию значение из памяти
`"statusKey": номер ключа статуса` - 

#### Вывод скрипта

##### send

1. `"send": "сообщение для вывода на экран"` - отправляет сообщение пользователю
2. `"sendOnX": "сообщение для вывода на экран"` - отправляет сообщение пользователю через X вводов пользователя
3. `"sendForXMins": "сообщение для вывода на экран"` - отправляет сообщение пользователю через X минут

##### sendStatus

4. `"statusKey": номер ключа в этом скрипте` - нумерует нижеуказанный статус для передачи в скрипт в функцию `update_status(key)`
5. `"sendStatus": "сообщение для вывода на экран"` - отправляет статус на экран с начальным текстом
6. `"sendWithValue": "ключ значения"` - отправляет в функцию статуса значение из памяти

##### storeValue

7. `"onKey": "ключ значения"` - устанавливает ключ для записи нижеуказанного значения в памяти
8. `"storeValue": "значение"` - устанавливает значение для ключа `onKey`

## Руководство по заполнению баз данных

