# cc-jeff

Джефф - настраиваемый и расширяемый чат-бот для десктопов со свободной лицензией.

## Сборка

Генерация Make-файла выполняется командой `$ cmake -S ./ -B /path/of/makefile/dir`.

## Описание

### Встроенный поиск выражений-триггеров

Джефф предоставляет встроенный поиск триггеров в введённых выражениях пользователя. Для ответа на них используются базы данных \*.j.db (SQLite).

Чтобы создать базу данных, откройте `Файл > Менеджер источников` или напишите сообщение `/src`. В ответном сообщении нажмите `Добавить контейнер |> Создать`, введите любое название источника, выберите файл для сохранения и нажмите `Сохранить`. Для сохранения изменений нажмите `Сохранить и закрыть`.

Содержимое базы данных включает в себя таблицу `sources` с определёнными свойствами, никнеймом источника (в одной базе данных может быть несколько источников) и его UUID, а также сами таблицы источников.

Источник представляет из себя таблицу с тремя столбцами: 

- адрес выражения
- само выражение
- ссылки от данного выражения на другие
- исполняемый бит (будет добавлен в версии 0.5.0).

Таким образом, использование баз данных может заключаться в подобном примере:

```
1 | Привет!                             | 1,2,3 | 0
2 | Здравствуй!                         | 1,2,3 | 0
3 | {"handle_in_script":"greetings.py"} |       | 1
4 | Что такое                           | 5     | 0
5 | {"handle_in_script":"wiki.py"}      |       | 1
```

Выражения могут ссылаться сами на себя. Выбор между вариантами происходит случайным образом.

Ядро поиска триггеров находится в классе `NLPmodule`. Ядро собирает из кэша выражения (если не находит - из остальных источников), освобождает от знаков препинания, делает регистронезависимыми, затем ищет их вхождения в пользовательский ввод. Если выражение активатора было найдено с определённой точностью, выражение реагирования добавляется в список кандидатов. Из списка кандидатов выбираются выражения с максимальным покрытием, наибольшим весом и наименьшим числом использования. Если использовался только кэш, и треть ввода не покрыта ответными выражениями, поиск повторяется по источникам.

### Скрипты и гибкая система настройки поведения (начиная с версии 0.5.0)

Джефф может обрабатывать выражения при помощи внешних скриптов в нескольких случаях:

1. При запуске программы (`startup`).
2. При любом вводе пользователя (`custom_scan`).
3. При необходимости ответить на ввод пользователя (`answer`).
4. При необходимости иначе скомпоновать полученные результаты (`custom_compose`).
5. При вводе специальных команд, когда ввод предназначен только для одного скрипта (`action_provider` и `go_action`).
6. При создании обновляемых сообщений (`get_status_update`).

Скрипты пишутся на Python и имеют расширение \*.j.py.

#### Внутренняя память Джеффа

У Джеффа есть два вида памяти: контекст и память скриптов.

Контекст:

1. + может быть установлен из выражений AIML/баз данных и скриптов
2. - хранит только текстовые значения

Память скриптов:

1. + может хранить любые значения JSON
2. - запись возможна только из скриптов

Предназначение контекста - общее, в то время как память скриптов предназначена только для них самих.

#### Запуск программы

Скрипт должен иметь функцию `startup` без аргументов.

#### Обработка ввода пользователя `custom_scan` (TBD)

*В настройках базы данных нужно указать путь до файла и название функции, а также указать, сколько последних сообщений должна получить функция.*

*Единственным аргументом передаётся JSON-строка с историей сообщений.*

#### Ответ на ввод пользователя (в процессе)

Выражение в базе данных должно выглядеть так:

```json
{
  "script_path": "путь до файла",
  "func_name": "название функции",
  "get_hist": "число последних сообщений"
}
```

Единственным аргументом передаётся JSON-строка с историей сообщений.

#### Кастомная компоновка результатов сканирования NLPmodule `custom_compose` (TBD)

*Выражение в базе данных должно выглядеть так:*

```json
{
  "handle_in_script": "путь до файла",
  "type": "custom_compose",
  "get_hist": "число последних сообщений"
}
```

*Скрипт должен иметь функцию `custom_compose` и принимать JSON-объект:*

```json
{
  "input": "ввод пользователя",
  "candidates": {
    "c1": ["активатор1", "реагент1", {
      "дополнительное свойство 1": "значение",
      "дополнительное свойство 2": "значение"
    }],
    "c2": ["активатор2", "реагент2"]
  }
}
```

*Компоновка автоматически передаётся скрипту из выражения с наибольшим весом, если активатор попал в выборку.*

#### Специальные команды `go_action` (TBD)

*Скрипт должен иметь функцию `action_provider`, возвращающий уникальные для конфигурации Джеффа команды, например, `/spotify-tui`, и их краткие описания (до 120 символов), в виде пар ключей-значений. Помимо этого, также должна быть функция `go_action`, которая принимает строку ввода, содержащую в том числе название команды.*

#### Обновляемые сообщения `get_status_update` (TBD)

*В ответе скрипта должны быть следующие опции:*

```json
{ 
  "...": "...",
  "createStatusMsg": true
}
```

*Скрипт должен иметь функцию `get_status_update` и принимать один аргумент - идентификатор сообщения.*

#### Вывод скрипта

Формат вывода - JSON. Пример вывода:

```json
{
  "send": "Привет, как дела?",
  "store_values": [{"key": "поприветствовал пользователя?", "value": true}]
}
```

##### send

1. `"send": "сообщение для вывода на экран"` - отправляет сообщение пользователю
2. `"send_for": {"msg": "сообщение для вывода на экран", "duration_secs": 60}` - отправляет сообщение пользователю через определённое количество секунд

##### sendStatus

4. `"statusID": "идентификатор"` - присваивает статусу идентификатор
5. `"sendStatus": "сообщение для вывода на экран"` - отправляет статус на экран с начальным текстом
6. `"sendStatusWithValue": "ключ значения"` - сообщение статуса автоматически обновляется при обновлении значения

##### store_values

7. `{"key": "ключ", "value": {...}}` - записывает в память скриптов любые значения JSON

##### recall

Если вывод имеет вид:

```json
{
  "recall": true,
  "need_values": ["ключ 1", "ключ 2"]
}
```

\- значит, функция требует дополнительные данные. Она будет перезапущена, и в качестве параметров будут переданы дополнительные значения.

## Руководство по заполнению баз данных

